# å¿«é€Ÿä¸Šæ‰‹


> [!TIP]
> å»ºè®®ä½¿ç”¨`--help`å‚æ•°äº†è§£æ¯ä¸ªå‘½ä»¤çš„å¯ç”¨é€‰é¡¹ã€‚
> `lighteval --help`

Lighteval æ”¯æŒå¤šç§å‘½ä»¤æ–¹å¼ï¼š

- `lighteval accelerate`: ä½¿ç”¨[ğŸ¤— Accelerate](https://github.com/huggingface/accelerate)åœ¨CPUæˆ–å¤šGPUç¯å¢ƒè¯„ä¼°æ¨¡å‹
- `lighteval nanotron`: é€šè¿‡[âš¡ï¸ Nanotron](https://github.com/huggingface/nanotron)åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­è¯„ä¼°æ¨¡å‹
- `lighteval vllm`: åŸºäº[ğŸš€ VLLM](https://github.com/vllm-project/vllm)åœ¨å•ä¸ªæˆ–å¤šä¸ªGPUä¸Šè¯„ä¼°æ¨¡å‹
- `lighteval endpoint`
    - `inference-endpoint`: ä½¿ç”¨[ğŸ”— Inference Endpoint](https://huggingface.co/inference-endpoints/dedicated)è¯„ä¼°æ¨¡å‹
    - `tgi`: é€šè¿‡[ğŸ”— Text Generation Inference](https://huggingface.co/docs/text-generation-inference/en/index)è¯„ä¼°æ¨¡å‹
    - `openai`: åŸºäº[ğŸ”— OpenAI API](https://platform.openai.com/)è¯„ä¼°æ¨¡å‹

## åŸºæœ¬ç”¨æ³•

è¦ä½¿ç”¨[ğŸ¤— Accelerate](https://github.com/huggingface/accelerate)åœ¨Truthful QAåŸºå‡†ä¸Šè¯„ä¼°`GPT-2`æ¨¡å‹ï¼Œè¿è¡Œï¼š

```bash
lighteval accelerate \
     "model_name=openai-community/gpt2" \
     "leaderboard|truthfulqa:mc|0|0"
```

åœ¨è¿™é‡Œï¼Œé¦–å…ˆé€‰æ‹©åç«¯ï¼ˆ`accelerate`ã€`nanotron`æˆ–`vllm`ï¼‰ï¼Œç„¶åæŒ‡å®šè¦è¯„ä¼°çš„æ¨¡å‹å’Œä»»åŠ¡ã€‚

æ¨¡å‹å‚æ•°é‡‡ç”¨`key1=value1,key2=value2`è¿™æ ·çš„è¯­æ³•æ ¼å¼ã€‚
æœ‰æ•ˆçš„é”®å€¼å¯¹å–å†³äºæ‰€é€‰åç«¯ï¼Œè¯¦ç»†è¯´æ˜è¯·å‚è§[ä¸‹æ–‡](#æ¨¡å‹å‚æ•°)ã€‚

ä»»åŠ¡è§„èŒƒçš„è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š

```txt
{å¥—ä»¶}|{ä»»åŠ¡}|{å°‘æ ·æœ¬æ•°é‡}|{0è¡¨ç¤ºä¸¥æ ¼ä½¿ç”¨æŒ‡å®šçš„å°‘æ ·æœ¬æ•°é‡ï¼Œ1è¡¨ç¤ºå…è®¸åœ¨ä¸Šä¸‹æ–‡è¿‡é•¿æ—¶è‡ªåŠ¨æˆªæ–­}
```

å½“ç¬¬å››ä¸ªå€¼è®¾ä¸º1æ—¶ï¼Œlightevalä¼šæ£€æŸ¥æ•´ä¸ªæç¤ºï¼ˆåŒ…æ‹¬å°‘æ ·æœ¬ç¤ºä¾‹ï¼‰æ˜¯å¦è¶…å‡ºä»»åŠ¡æˆ–æ¨¡å‹çš„ä¸Šä¸‹æ–‡é•¿åº¦é™åˆ¶ã€‚
å¦‚æœè¶…å‡ºé™åˆ¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å‡å°‘å°‘æ ·æœ¬ç¤ºä¾‹çš„æ•°é‡ã€‚

æ‰€æœ‰å®˜æ–¹æ”¯æŒçš„ä»»åŠ¡å¯åœ¨[ä»»åŠ¡åˆ—è¡¨](available-tasks)å’Œ
[extendedæ–‡ä»¶å¤¹](https://github.com/huggingface/lighteval/tree/main/src/lighteval/tasks/extended)ä¸­æ‰¾åˆ°ã€‚
ç¤¾åŒºè´¡çŒ®çš„ä»»åŠ¡åˆ™ä½äº
[community](https://github.com/huggingface/lighteval/tree/main/community_tasks)æ–‡ä»¶å¤¹ã€‚
å…³äºä»»åŠ¡å®ç°çš„æ›´å¤šç»†èŠ‚ï¼Œå¦‚æç¤ºæ„å»ºæ–¹å¼æˆ–ä½¿ç”¨çš„è¯„ä¼°æŒ‡æ ‡ï¼Œè¯·æŸ¥é˜…
[æºæ–‡ä»¶](https://github.com/huggingface/lighteval/blob/main/src/lighteval/tasks/default_tasks.py)ã€‚

Lightevalæ”¯æŒåŒæ—¶è¿è¡Œå¤šä¸ªä»»åŠ¡ï¼Œå¯é€šè¿‡é€—å·åˆ†éš”åˆ—è¡¨æˆ–æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„æ¥å®ç°ã€‚
é…ç½®æ–‡ä»¶åº”æŒ‰ç…§[examples/tasks/recommended_set.txt](https://github.com/huggingface/lighteval/blob/main/examples/tasks/recommended_set.txt)çš„ç»“æ„ç¼–å†™ã€‚
æŒ‡å®šæ–‡ä»¶è·¯å¾„æ—¶åº”ä»¥`./`å¼€å¤´ã€‚

```bash
lighteval accelerate \
     "model_name=openai-community/gpt2" \
     ./path/to/lighteval/examples/tasks/recommended_set.txt
# æˆ–è€…ä½¿ç”¨é€—å·åˆ†éš”çš„ä»»åŠ¡åˆ—è¡¨ï¼Œä¾‹å¦‚ï¼š"leaderboard|truthfulqa:mc|0|0|,leaderboard|gsm8k|3|1"
```

## åœ¨å¤šGPUç¯å¢ƒä¸­è¯„ä¼°æ¨¡å‹

#### æ•°æ®å¹¶è¡Œ

è¦åœ¨å¤šGPUç¯å¢ƒä¸­è¯„ä¼°æ¨¡å‹ï¼Œé¦–å…ˆéœ€è¦åˆ›å»ºå¤šGPUé…ç½®ï¼š

```bash
accelerate config
```

ç„¶åï¼Œå¯ä»¥ä½¿ç”¨8ä¸ªGPUçš„æ•°æ®å¹¶è¡Œæ–¹å¼æ¥è¯„ä¼°æ¨¡å‹ï¼š

```bash
accelerate launch --multi_gpu --num_processes=8 -m \
    lighteval accelerate \
    "model_name=openai-community/gpt2" \
    "leaderboard|truthfulqa:mc|0|0"
```

å…¶ä¸­ï¼Œ`--override_batch_size`å®šä¹‰æ¯ä¸ªè®¾å¤‡çš„æ‰¹å¤„ç†å¤§å°ï¼Œå®é™…æ€»æ‰¹å¤„ç†å¤§å°ä¸º`override_batch_size * num_gpus`ã€‚

#### æµæ°´çº¿å¹¶è¡Œ

è¦ä½¿ç”¨2ä¸ªæˆ–æ›´å¤šGPUçš„æµæ°´çº¿å¹¶è¡Œæ–¹å¼è¯„ä¼°æ¨¡å‹ï¼Œè¿è¡Œï¼š

```bash
lighteval accelerate \
    "model_name=openai-community/gpt2,model_parallel=True" \
    "leaderboard|truthfulqa:mc|0|0"
```

è¿™ä¼šè‡ªåŠ¨ä½¿ç”¨accelerateå°†æ¨¡å‹åˆ†å¸ƒåœ¨å¤šä¸ªGPUä¸Šã€‚

> [!TIP]
> æ•°æ®å¹¶è¡Œå’Œæµæ°´çº¿å¹¶è¡Œå¯ä»¥ç»“åˆä½¿ç”¨ï¼Œåªéœ€è®¾ç½®`model_parallel=True`å¹¶ä½¿ç”¨accelerateè¿›è¡Œæ•°æ®åˆ†å¸ƒã€‚

## åç«¯é…ç½®

`model-args`å‚æ•°æ¥å—ä¸€ä¸ªæ¨¡å‹å‚æ•°åˆ—è¡¨å­—ç¬¦ä¸²ã€‚å¯ç”¨å‚æ•°å–å†³äºæ‰€é€‰åç«¯ï¼ˆvllmæˆ–accelerateï¼‰ã€‚

### Accelerate

- **pretrained** (str):
    HuggingFace Hubæ¨¡å‹IDæˆ–é¢„è®­ç»ƒæ¨¡å‹è·¯å¾„ï¼Œç›¸å½“äºHuggingFace `transformers` APIä¸­`from_pretrained`çš„`pretrained_model_name_or_path`å‚æ•°ã€‚
- **tokenizer** (Optional[str]): ç”¨äºåˆ†è¯çš„HuggingFace Hubåˆ†è¯å™¨IDã€‚
- **multichoice_continuations_start_space** (Optional[bool]): åœ¨å¤šé€‰é¡¹ç”Ÿæˆä¸­æ˜¯å¦åœ¨æ¯ä¸ªé€‰é¡¹å¼€å¤´æ·»åŠ ç©ºæ ¼ã€‚
    ä¾‹å¦‚ï¼Œå¯¹äºé—®é¢˜"æ³•å›½çš„é¦–éƒ½æ˜¯ä»€ä¹ˆï¼Ÿ"å’Œé€‰é¡¹"å·´é»"ã€"ä¼¦æ•¦"ï¼Œ
    ä¼šè¢«åˆ†è¯ä¸º"æ³•å›½çš„é¦–éƒ½æ˜¯ä»€ä¹ˆï¼Ÿå·´é»"å’Œ"æ³•å›½çš„é¦–éƒ½æ˜¯ä»€ä¹ˆï¼Ÿä¼¦æ•¦"ã€‚
    Trueè¡¨ç¤ºæ·»åŠ ç©ºæ ¼ï¼ŒFalseè¡¨ç¤ºå»é™¤ç©ºæ ¼ï¼ŒNoneè¡¨ç¤ºä¸åšå¤„ç†ã€‚
- **subfolder** (Optional[str]): æ¨¡å‹ä»“åº“ä¸­çš„å­æ–‡ä»¶å¤¹ã€‚
- **revision** (str): æ¨¡å‹çš„ç‰ˆæœ¬ã€‚
- **max_gen_toks** (Optional[int]): ç”Ÿæˆçš„æœ€å¤§tokenæ•°é‡ã€‚
- **max_length** (Optional[int]): ç”Ÿæˆè¾“å‡ºçš„æœ€å¤§é•¿åº¦ã€‚
- **add_special_tokens** (bool, optional, defaults to True): æ˜¯å¦å‘è¾“å…¥åºåˆ—æ·»åŠ ç‰¹æ®Štokenã€‚
   å¦‚æœä¸º`None`ï¼Œå¯¹äºseq2seqæ¨¡å‹ï¼ˆå¦‚T5ï¼‰é»˜è®¤å€¼ä¸º`True`ï¼Œå¯¹äºå› æœæ¨¡å‹é»˜è®¤ä¸º`False`ã€‚
- **model_parallel** (bool, optional, defaults to None):
    True/False: å¼ºåˆ¶ä½¿ç”¨æˆ–ä¸ä½¿ç”¨`accelerate`åº“åœ¨å¤šè®¾å¤‡é—´åˆ†å¸ƒå¤§å‹æ¨¡å‹ã€‚
    é»˜è®¤ä¸ºNoneï¼Œä¼šæ¯”è¾ƒè¿›ç¨‹æ•°ä¸GPUæ•°ï¼šè‹¥è¿›ç¨‹æ•°å°äºGPUæ•°åˆ™å¯ç”¨æ¨¡å‹å¹¶è¡Œï¼Œå¦åˆ™ä¸å¯ç”¨ã€‚
- **dtype** (Union[str, torch.dtype], optional, defaults to None):
    å¦‚æŒ‡å®šï¼Œåˆ™å°†æ¨¡å‹æƒé‡è½¬æ¢ä¸ºè¯¥æ•°æ®ç±»å‹ã€‚å­—ç¬¦ä¸²ä¼šè¢«è½¬æ¢ä¸º`torch.dtype`å¯¹è±¡ï¼ˆå¦‚`float16` -> `torch.float16`ï¼‰ã€‚
    ä½¿ç”¨`dtype="auto"`å¯ä»æ¨¡å‹æƒé‡è‡ªåŠ¨æ¨å¯¼ç±»å‹ã€‚
- **device** (Union[int, str]): ç”¨äºæ¨¡å‹è®­ç»ƒçš„è®¾å¤‡ã€‚
- **quantization_config** (Optional[BitsAndBytesConfig]): æ¨¡å‹é‡åŒ–é…ç½®ï¼Œç”¨äºä»¥é‡åŒ–ç²¾åº¦åŠ è½½åŸæœ¬ä¸ºæµ®ç‚¹çš„æ¨¡å‹ã€‚4ä½å’Œ8ä½ç²¾åº¦éœ€è¦æ­¤é…ç½®ã€‚
- **trust_remote_code** (bool): åŠ è½½æ¨¡å‹æ—¶æ˜¯å¦ä¿¡ä»»è¿œç¨‹ä»£ç ã€‚

### VLLM

- **pretrained** (str): HuggingFace Hubæ¨¡å‹IDæˆ–é¢„è®­ç»ƒæ¨¡å‹è·¯å¾„ã€‚
- **gpu_memory_utilization** (float): GPUå†…å­˜ä½¿ç”¨æ¯”ä¾‹ã€‚
- **batch_size** (int): æ¨¡å‹è®­ç»ƒçš„æ‰¹å¤„ç†å¤§å°ã€‚
- **revision** (str): æ¨¡å‹ç‰ˆæœ¬ã€‚
- **dtype** (str, None): æ¨¡å‹ä½¿ç”¨çš„æ•°æ®ç±»å‹ã€‚
- **tensor_parallel_size** (int): ä½¿ç”¨çš„å¼ é‡å¹¶è¡Œå•å…ƒæ•°é‡ã€‚
- **data_parallel_size** (int): ä½¿ç”¨çš„æ•°æ®å¹¶è¡Œå•å…ƒæ•°é‡ã€‚
- **max_model_length** (int): æ¨¡å‹çš„æœ€å¤§é•¿åº¦ã€‚
- **swap_space** (int): æ¯ä¸ªGPUçš„CPUäº¤æ¢ç©ºé—´å¤§å°ï¼ˆGiBï¼‰ã€‚
- **seed** (int): æ¨¡å‹ä½¿ç”¨çš„éšæœºç§å­ã€‚
- **trust_remote_code** (bool): åŠ è½½æ¨¡å‹æ—¶æ˜¯å¦ä¿¡ä»»è¿œç¨‹ä»£ç ã€‚
- **use_chat_template** (bool): æ˜¯å¦ä½¿ç”¨èŠå¤©æ¨¡æ¿ã€‚
- **add_special_tokens** (bool): æ˜¯å¦å‘è¾“å…¥åºåˆ—æ·»åŠ ç‰¹æ®Štokenã€‚
- **multichoice_continuations_start_space** (bool): åœ¨å¤šé€‰é¡¹ç”Ÿæˆä¸­æ˜¯å¦åœ¨æ¯ä¸ªé€‰é¡¹å¼€å¤´æ·»åŠ ç©ºæ ¼ã€‚
- **subfolder** (Optional[str]): æ¨¡å‹ä»“åº“ä¸­çš„å­æ–‡ä»¶å¤¹ã€‚

## Nanotron

è¦è¯„ä¼°ä½¿ç”¨nanotronè®­ç»ƒçš„æ¨¡å‹ï¼š

> [!WARNING]
> Nanotronæ¨¡å‹å¿…é¡»ä½¿ç”¨torchrunè¿›è¡Œè¯„ä¼°ã€‚


```bash
 torchrun --standalone --nnodes=1 --nproc-per-node=1  \
 src/lighteval/__main__.py nanotron \
 --checkpoint-config-path ../nanotron/checkpoints/10/config.yaml \
 --lighteval-config-path examples/nanotron/lighteval_config_override_template.yaml
 ```

`nproc-per-node`å‚æ•°åº”ä¸`lighteval_config_template.yaml`æ–‡ä»¶ä¸­é…ç½®çš„å¹¶è¡Œè®¾ç½®åŒ¹é…ï¼Œ
å³ï¼š`nproc-per-node = data_parallelism * tensor_parallelism * pipeline_parallelism`ã€‚ 